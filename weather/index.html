<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“é¦™æ¸¯å¤©æ°£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #aqhi-map {
            height: 400px;
            width: 100%;
        }
        .info {
            padding: 6px 8px;
            font-size: 14px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .low { color: green; font-weight: bold; }
        .moderate { color: orange; font-weight: bold; }
        .high { color: red; font-weight: bold; }
        .very-high { color: brown; font-weight: bold; }
        .serious { color: black; font-weight: bold; }
        .aqhi-value {
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            text-align: center;
            line-height: 24px;
        }
        .leaflet-control-attribution {
            display: none;
        }
    </style>
</head>
<body class="bg-sky-50 min-h-screen flex flex-col items-center p-4">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-100 to-blue-200 w-full max-w-5xl mx-auto rounded-xl shadow-md py-6 mb-6">
        <h3 class="text-3xl font-bold text-gray-800 text-center">milodwl.github.io</h3>
        <h1 class="text-3xl font-bold text-gray-800 text-center">ç°¡æ˜“é¦™æ¸¯å¤©æ°£</h1>
    </header>

    <!-- Main Content -->
    <div class="w-full max-w-5xl mx-auto space-y-6">
        <!-- Part 1: Current Weather and Warnings -->
        <div id="current-weather" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="current-status" class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">å¤©æ°£ç‹€æ…‹</h2>
                <p id="temperature" class="text-gray-700"><span class="font-semibold">ç¾æ™‚æ°£æº«:</span> è¼‰å…¥ä¸­...</p>
                <p id="humidity" class="text-gray-700"><span class="font-semibold">ç¾æ™‚æ¿•åº¦:</span> è¼‰å…¥ä¸­...</p>
                <p id="uv-index" class="text-gray-700"><span class="font-semibold">ç´«å¤–ç¶«æŒ‡æ•¸:</span> è¼‰å…¥ä¸­...</p>
                <p id="local-forecast" class="text-gray-700"><span class="font-semibold">æœ¬æ¸¯é å ±:</span> è¼‰å…¥ä¸­...</p>
                <img id="weather-icon" class="w-12 h-12 rounded-full p-2 bg-blue-50 mt-4" alt="Weather Icon">
            </div>
            <div id="warnings" class="bg-amber-50 rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">å¤©æ°£è­¦å‘Š</h2>
                <div id="warnings-data" class="space-y-2"></div>
            </div>
        </div>

        <!-- Part 2: 9-Day Weather Forecast with Chart -->
        <div id="forecast" class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ä¹å¤©å¤©æ°£é å ±</h2>
                <span class="text-sm text-blue-600 ml-2">é»æ“Šåœ–è¡¨æŸ¥çœ‹è©³æƒ…</span>
            </div>
            <canvas id="tempChart" class="w-full h-64 cursor-pointer transform hover:scale-[1.02] transition-transform duration-200"></canvas>
        </div>

        <!-- Part 3: AQHI Map -->
        <div id="aqhi" class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">é¦™æ¸¯ç©ºæ°£è³ªç´ å¥åº·æŒ‡æ•¸ï¼ˆAQHIï¼‰</h2>
            <div id="aqhi-map"></div>
            <p id="aqhi-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>

    <!-- Modal for Detailed Forecast -->
    <div id="forecast-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">è©³ç´°ä¹å¤©å¤©æ°£é å ±</h2>
            <div id="forecast-data" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            <button id="close-modal" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">é—œé–‰</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-50 w-full mt-6 border-t border-gray-200">
        <p class="text-sm font-medium text-gray-600 text-center py-4">æ•¸æ“šä¾†æºè‡ªé¦™æ¸¯å¤©æ–‡å°åŠé¦™æ¸¯ç’°å¢ƒä¿è­·ç½²ï¼Œæœ¬ç¶²é æ­£åœ¨æ¸¬è©¦ä¸­</p>
        <p class="text-sm font-medium text-gray-600 text-center py-4">Â© milodwl.github.io</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }

        let forecastData = [];

        // Fetch current weather and UV index
        function fetchCurrentWeather() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    const temp = data.temperature.data[0];
                    $('#temperature').html(`<span class="font-semibold">ç¾æ™‚æ°£æº«:</span> ${temp.value}Â°${temp.unit}`);
                    const humidity = data.humidity.data[0];
                    $('#humidity').html(`<span class="font-semibold">ç¾æ™‚æ¿•åº¦:</span> ${humidity.value}%`);
                    const icon = data.icon[0];
                    $('#weather-icon').attr('src', `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${icon}.png`);
                    if (data.uvindex && data.uvindex.data && data.uvindex.data.length > 0) {
                        const uvData = data.uvindex.data[0];
                        const uvValue = uvData.value !== undefined ? uvData.value : 'N/A';
                        const uvDesc = uvData.desc || 'N/A';
                        $('#uv-index').html(`<span class="font-semibold">ç´«å¤–ç¶«æŒ‡æ•¸:</span> ${uvValue} (${uvDesc})`);
                    } else {
                        $('#uv-index').html('<span class="font-semibold">ç´«å¤–ç¶«æŒ‡æ•¸:</span> <span class="text-red-500">ç„¡æ³•è¼‰å…¥ç´«å¤–ç¶«è³‡æ–™</span>');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Current Weather API Error:', textStatus, errorThrown);
                    $('#current-status').html('<p class="text-red-500">ç„¡æ³•è¼‰å…¥ç•¶å‰å¤©æ°£</p>');
                }
            });
        }

        function fetchLocalForecast() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=flw&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    const generalSituation = data.generalSituation || '';
                    const forecastPeriod = data.forecastPeriod || '';
                    const forecastDesc = data.forecastDesc || '';
                    const outlook = data.outlook || '';
                    let combinedForecast = 'N/A';
                    if (generalSituation || forecastPeriod || forecastDesc || outlook) {
                        combinedForecast = `${generalSituation}${forecastPeriod}${forecastDesc}${outlook}`;
                    }
                    $('#local-forecast').html(`<span class="font-semibold">æœ¬æ¸¯é å ±:</span> ${combinedForecast}`);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Local Forecast API Error:', textStatus, errorThrown);
                    $('#local-forecast').html('<p class="text-red-500">ç„¡æ³•è¼‰å…¥æœ¬æ¸¯é å ±</p>');
                }
            });
        }

        function fetchTodayTempRange() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    forecastData = data.weatherForecast;
                    renderForecastChart();
                    populateForecastModal();
                },
                error: function() {
                    console.error('9-Day Forecast API Error');
                }
            });
        }

        function fetchWarnings() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#warnings-data').empty();
                    for (const [code, warning] of Object.entries(data)) {
                        if (warning.name) {
                            const warningHtml = `
                                <div class="bg-amber-100 p-2 rounded-lg hover:bg-amber-200 transition duration-200">
                                    <p class="font-semibold">${warning.name}</p>
                                    <p class="text-sm text-gray-600">ç™¼å‡º: ${warning.issueTime}</p>
                                </div>`;
                            $('#warnings-data').append(warningHtml);
                        }
                    }
                    if ($('#warnings-data').is(':empty')) {
                        $('#warnings-data').html('<p class="text-gray-600">ç›®å‰ç„¡å¤©æ°£è­¦å‘Š</p>');
                    }
                },
                error: function() {
                    $('#warnings-data').html('<p class="text-red-500">ç„¡æ³•è¼‰å…¥å¤©æ°£è­¦å‘Š</p>');
                }
            });
        }

        function renderForecastChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const dates = forecastData.map(f => f.forecastDate);
            const maxTemps = forecastData.map(f => f.forecastMaxtemp.value);
            const minTemps = forecastData.map(f => f.forecastMintemp.value);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'æœ€é«˜æº«åº¦ (Â°C)',
                            data: maxTemps,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'æœ€ä½æº«åº¦ (Â°C)',
                            data: minTemps,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'æº«åº¦ (Â°C)', color: '#4B5563' }
                        },
                        x: {
                            title: { display: true, text: 'æ—¥æœŸ', color: '#4B5563' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#4B5563' }
                        }
                    }
                }
            });
        }

        function populateForecastModal() {
            $('#forecast-data').empty();
            forecastData.forEach(forecast => {
                const forecastHtml = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-700"><span class="font-semibold">æ—¥æœŸ:</span> ${forecast.forecastDate}</p>
                        <p class="text-gray-700"><span class="font-semibold">æ˜ŸæœŸ:</span> ${forecast.week}</p>
                        <p class="text-gray-700"><span class="font-semibold">å¤©æ°£:</span> ${forecast.forecastWeather}</p>
                        <p class="text-gray-700"><span class="font-semibold">æœ€é«˜æº«åº¦:</span> ${forecast.forecastMaxtemp.value}Â°${forecast.forecastMaxtemp.unit}</p>
                        <p class="text-gray-700"><span class="font-semibold">æœ€ä½æº«åº¦:</span> ${forecast.forecastMintemp.value}Â°${forecast.forecastMintemp.unit}</p>
                        <p class="text-gray-700"><span class="font-semibold">é™é›¨æ¦‚ç‡:</span> ${forecast.PSR}</p>
                        <p class="text-gray-700"><span class="font-semibold">é¢¨å‘é¢¨é€Ÿ:</span> ${forecast.forecastWind}</p>
                        <p class="text-gray-700"><span class="font-semibold">ç›¸å°æ¿•åº¦:</span> ${forecast.forecastMinrh.value}% - ${forecast.forecastMaxrh.value}%</p>
                        <img src="https://www.hko.gov.hk/images/HKOWxIconOutline/pic${forecast.ForecastIcon}.png" alt="Weather Icon" class="w-12 h-12 mt-2">
                    </div>`;
                $('#forecast-data').append(forecastHtml);
            });
        }

        // AQHI Map Functionality
        function initAqhiMap() {
            const map = L.map('aqhi-map', {
                attributionControl: false
            }).setView([22.3193, 114.1694], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const districts = {
                "ä¸­è¥¿å€": [22.2799, 114.1474],
                "å—å€": [22.2432, 114.1974],
                "æ±å€": [22.2798, 114.2241],
                "è§€å¡˜": [22.3129, 114.2258],
                "æ·±æ°´åŸ—": [22.3331, 114.1628],
                "è‘µæ¶Œ": [22.3639, 114.1394],
                "èƒç£": [22.3683, 114.1241],
                "å°‡è»æ¾³": [22.3080, 114.2586],
                "å…ƒæœ—": [22.4445, 114.0222],
                "å±¯é–€": [22.3916, 113.9751],
                "æ±æ¶Œ": [22.2894, 113.9441],
                "å¤§åŸ”": [22.4457, 114.1687],
                "æ²™ç”°": [22.3871, 114.1954],
                "åŒ—å€": [22.4947, 114.1381],
                "å¡”é–€": [22.4978, 114.3557]
            };

            const proxyUrl = "https://api.allorigins.win/raw?url=";
            const targetUrl = "https://www.aqhi.gov.hk/epd/ddata/html/out/aqhi_ind_rss_ChT.xml";

            fetch(proxyUrl + encodeURIComponent(targetUrl))
                .then(response => response.text())
                .then(str => {
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(str, "application/xml");
                    const items = xml.querySelectorAll("item");

                    items.forEach(item => {
                        const title = item.querySelector("title").textContent;
                        const [district, index, level] = title.split(" : ");
                        if (districts[district]) {
                            const [lat, lng] = districts[district];
                            let levelClass = "low";
                            let color = 'green';

                            if (level.includes("ä¸­")) {
                                levelClass = "moderate";
                                color = 'orange';
                            } else if (level.includes("ç”šé«˜")) {
                                levelClass = "very-high";
                                color = 'brown';
                            } else if (level.includes("åš´é‡")) {
                                levelClass = "serious";
                                color = 'black';
                            } else if (level.includes("é«˜")) {
                                levelClass = "high";
                                color = 'red';
                            }

                            L.circleMarker([lat, lng], {
                                radius: 12,
                                fillColor: color,
                                color: '#000',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map)
                                .bindPopup(`
                                    <b>${district}</b><br>
                                    æŒ‡æ•¸: ${index}<br>
                                    é¢¨éšªç´šåˆ¥: <span class="${levelClass}">${level}</span>
                                `);

                            L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'aqhi-value',
                                    html: index,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).addTo(map)
                                .bindPopup(`
                                    <b>${district}</b><br>
                                    æŒ‡æ•¸: ${index}<br>
                                    é¢¨éšªç´šåˆ¥: <span class="${levelClass}">${level}</span>
                                `);
                        }
                    });

                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function (map) {
                        const div = L.DomUtil.create('div', 'info legend');
                        const grades = [
                            {label: 'ä½', color: 'green'},
                            {label: 'ä¸­', color: 'orange'},
                            {label: 'é«˜', color: 'red'},
                            {label: 'ç”šé«˜', color: 'brown'},
                            {label: 'åš´é‡', color: 'black'}
                        ];
                        grades.forEach(grade => {
                            div.innerHTML +=
                                `<i style="background:${grade.color}"></i> ${grade.label}<br>`;
                        });
                        return div;
                    };
                    legend.addTo(map);
                })
                .catch(err => {
                    console.error("ğŸ’¥ éŒ¯èª¤ï¼š", err);
                    document.getElementById('aqhi-error').textContent = "âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼ˆå¯èƒ½æ˜¯ Proxy è¢«å°é–ï¼‰ã€‚";
                });
        }

        // Modal toggle
        $('#tempChart').click(function() {
            $('#forecast-modal').removeClass('hidden').addClass('opacity-100');
        });

        $('#forecast-modal').click(function(e) {
            if (e.target.id === 'forecast-modal') {
                $('#forecast-modal').addClass('hidden').removeClass('opacity-100');
            }
        });

        $('#close-modal').click(function() {
            $('#forecast-modal').addClass('hidden').removeClass('opacity-100');
        });

        // Initialize data fetching
        $(document).ready(function() {
            fetchCurrentWeather();
            fetchLocalForecast();
            fetchTodayTempRange();
            fetchWarnings();
            initAqhiMap();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'932c3eb72bb8453d',t:'MTc0NTA2NDA2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9330ec3ace5844de',t:'MTc0NTExMzExMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>