<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>簡易香港天氣</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Leaflet CSS for rainfall map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .windy-iframe {
            width: 100%;
            height: 310px;
        }

        @media (min-width: 768px) {
            .windy-iframe {
                height: 310px;
            }
        }

        #special-weather-modal {
            z-index: 60;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        marquee {
            display: block;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Rainfall marker styles */
        .rainfall-marker {
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border: 1px solid black;
        }

        .rainfall-marker-zero {
            background-color: white;
            color: black;
        }

        .rainfall-marker-low {
            background-color: #00cc00;
            color: black;
        }

        .rainfall-marker-medium {
            background-color: #ffff00;
            color: black;
        }

        .rainfall-marker-high {
            background-color: #ff0000;
            color: black;
        }

        .rainfall-marker-extreme {
            background-color: black;
            color: white;
        }

        #map {
            width: 100%;
            height: 400px;
            max-width: 5xl;
            margin: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-sky-50 min-h-screen flex flex-col items-center p-4">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-100 to-blue-200 w-full max-w-5xl mx-auto rounded-xl shadow-md py-6 mb-6">
        <h3 class="text-3xl font-bold text-gray-800 text-center">miloisme.github.io</h3>
        <h1 class="text-3xl font-bold text-gray-800 text-center">簡易香港天氣</h1>
    </header>

    <!-- Special Weather Marquee -->
    <div id="special-weather-marquee" class="w-full max-w-5xl mx-auto bg-amber-50 rounded-xl shadow-md p-4 mb-6 hidden">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">特別天氣提示</h2>
        <div id="marquee-content"></div>
    </div>

    <!-- Main Content -->
    <div class="w-full max-w-5xl mx-auto space-y-6">
        <div class="mt-4 max-w-5xl mx-auto bg-white rounded-xl shadow-md p-4">
            <div class="grid grid-cols-5 gap-0">
                <div class="flex flex-col items-center">
                    <span class="mb-1 text-gray-700 font-medium text-center">中環(維港)</span>
                    <img src="https://www.hko.gov.hk/wxinfo/aws/hko_mica/cp1/latest_CP1.jpg" alt="中環(維港)"
                        class="w-full object-contain" />
                </div>
                <div class="flex flex-col items-center">
                    <span class="mb-1 text-gray-700 font-medium text-center">太平山向東</span>
                    <img src="https://www.hko.gov.hk/wxinfo/aws/hko_mica/vpa/latest_VPA.jpg" alt="太平山向東"
                        class="w-full object-contain" />
                </div>
                <div class="flex flex-col items-center">
                    <span class="mb-1 text-gray-700 font-medium text-center">尖沙咀</span>
                    <img src="https://www.hko.gov.hk/wxinfo/aws/hko_mica/hk2/latest_HK2.jpg" alt="尖沙咀"
                        class="w-full object-contain" />
                </div>
                <div class="flex flex-col items-center">
                    <span class="mb-1 text-gray-700 font-medium text-center">長洲</span>
                    <img src="https://www.hko.gov.hk/wxinfo/aws/hko_mica/cch/latest_CCH.jpg" alt="長洲"
                        class="w-full object-contain" />
                </div>
                <div class="flex flex-col items-center">
                    <span class="mb-1 text-gray-700 font-medium text-center">上水</span>
                    <img src="https://www.hko.gov.hk/wxinfo/aws/hko_mica/elc/latest_ELC.jpg" alt="上水(風采中學)"
                        class="w-full object-contain" />
                </div>
            </div>
        </div>

        <!-- Current Weather and Warnings -->
        <div id="current-weather" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="current-status" class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">天氣狀態</h2>
                <p id="temperature" class="text-gray-700"><span class="font-semibold">現時氣溫:</span> 載入中...</p>
                <p id="humidity" class="text-gray-700"><span class="font-semibold">現時濕度:</span> 載入中...</p>
                <p id="uv-index" class="text-gray-700"><span class="font-semibold">紫外綫指數:</span> 載入中...</p>
                <p id="local-forecast" class="text-gray-700"><span class="font-semibold">本港預報:</span> 載入中...</p>
            </div>
            <div id="warnings" class="bg-amber-50 rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">天氣警告</h2>
                <span class="text-sm text-blue-600 ml-2">點擊圖標查看詳情</span>
                <div id="warnings-data" class="flex flex-wrap gap-4"></div>
            </div>
        </div>

        <!-- Rainfall Map (New Section) -->
        <div id="rainfall-map-section" class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">指定地區過去一小時雨量地圖</h2>
            <div id="map" class="w-full max-w-5xl mx-auto shadow-sm"></div>
        </div>

        <!-- Forecast -->
        <div id="forecast" class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">九天天氣預報</h2>
                <span class="text-sm text-blue-600 ml-2">點擊圖表查看詳情</span>
            </div>
            <canvas id="tempChart"
                class="w-full h-64 cursor-pointer transform hover:scale-[1.02] transition-transform duration-200"></canvas>
        </div>

        <!-- Windy Maps -->
        <div id="windy-maps" class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">實時天氣地圖</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2 text-center">雷達</h3>
                    <iframe class="windy-iframe" loading="lazy"
                        src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=5&overlay=radar&product=radar&level=surface&lat=21.55&lon=114.293"
                        frameborder="0"></iframe>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2 text-center">陣風</h3>
                    <iframe class="windy-iframe" loading="lazy"
                        src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=5&overlay=wind&product=ecmwf&level=surface&lat=21.55&lon=114.293"
                        frameborder="0"></iframe>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2 text-center">雨及雷暴</h3>
                    <iframe class="windy-iframe" loading="lazy"
                        src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=5&overlay=rain&product=ecmwf&level=surface&lat=21.55&lon=114.293"
                        frameborder="0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warning-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg max-h-[80vh] overflow-y-auto relative">
            <button id="close-warning-modal"
                class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
            <h2 id="warning-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="warning-update-time" class="text-sm text-gray-600 mb-2"></p>
            <div id="warning-content" class="text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Special Weather Modal -->
    <div id="special-weather-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
        <div class="bg-white rounded-xl shadow-xl p-4 w-full max-w-md max-h-[70vh] overflow-y-auto relative">
            <button id="close-special-weather-modal"
                class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-xl font-bold">&times;</button>
            <h2 id="special-weather-title" class="text-lg font-bold text-gray-800 mb-2">特別天氣提示</h2>
            <div id="special-weather-content" class="text-base text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Forecast Modal -->
    <div id="forecast-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 z-40">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto relative">
            <button id="close-modal"
                class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
            <h2 class="text-xl font-bold text-gray-800 mb-4">詳細九天天氣預報</h2>
            <div id="forecast-data" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let forecastData = [];
        const iconMap = {
            "WTS": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/ts.issuing.gif",
            "WHOT": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/vhot.issuing.gif",
            "WRAINA": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/raina.issuing.gif",
            "WRAINR": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/rainr.issuing.gif",
            "WRAINB": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/rainb.issuing.gif",
            "TC1": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc1.issuing.gif",
            "TC3": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc3.issuing.gif",
            "TC8NE": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8ne.issuing.gif",
            "TC8SE": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8se.issuing.gif",
            "TC8SW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8sw.issuing.gif",
            "TC8NW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8nw.issuing.gif",
            "TC9": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc9.issuing.gif",
            "TC10": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc10.issuing.gif",
            "WCOLD": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/cold.issuing.gif",
            "WFROST": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/frost.issuing.gif",
            "WFIREY": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/firey.issuing.gif",
            "WFIRER": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/firer.issuing.gif",
            "WL": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/landslip.issuing.gif",
            "WFNTSA": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/ntfl.issuing.gif",
            "WTMW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tsunami-warn.issuing.gif",
            "CANCEL": ""
        };
        const subtypeMap = {
            "WFIRE": "火災危險警告",
            "WFIREY": "黃色火災危險警告",
            "WFIRER": "紅色火災危險警告",
            "WFROST": "霜凍警告",
            "WHOT": "酷熱天氣警告",
            "WCOLD": "寒冷天氣警告",
            "WMSGNL": "強烈季候風信號",
            "WTCPRE8": "八號熱帶氣旋預警特別報告",
            "WTCSGNL": "熱帶氣旋警告信號",
            "TC1": "一號戒備信號",
            "TC3": "三號強風信號",
            "TC8NE": "八號東北烈風信號",
            "TC8SE": "八號東南烈風信號",
            "TC8SW": "八號西南烈風信號",
            "TC8NW": "八號西北烈風信號",
            "TC9": "九號烈風增強信號",
            "TC10": "十號颶風信號",
            "CANCEL": "所有熱帶氣旋警告取消",
            "WRAIN": "暴雨警告",
            "WRAINA": "黃色暴雨警告",
            "WRAINR": "紅色暴雨警告",
            "WRAINB": "黑色暴雨警告",
            "WFNTSA": "新界北水浸特別報告",
            "WL": "山泥傾瀉警告",
            "WTMW": "海嘯警告",
            "WTS": "雷暴警告"
        };

        function fetchCurrentWeather() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    const temp = data.temperature.data[0];
                    $('#temperature').html(`<span class="font-semibold">現時氣溫:</span> ${temp.value}°${temp.unit}`);
                    const humidity = data.humidity.data[0];
                    $('#humidity').html(`<span class="font-semibold">現時濕度:</span> ${humidity.value}%`);
                    if (data.uvindex?.data?.length > 0) {
                        const uv = data.uvindex.data[0];
                        $('#uv-index').html(`<span class="font-semibold">紫外綫指數:</span> ${uv.value} (${uv.desc || ''})`);
                    } else {
                        $('#uv-index').html('<span class="font-semibold">紫外綫指數:</span> <span class="text-red-500">無法載入/現時不適用</span>');
                    }
                },
                error: () => $('#current-status').html('<p class="text-red-500">無法載入當前天氣</p>')
            });
        }

        function fetchLocalForecast() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=flw&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    const text = [data.generalSituation, data.forecastPeriod, data.forecastDesc, data.outlook].join('');
                    $('#local-forecast').html(`<span class="font-semibold">本港預報:</span> ${text || 'N/A'}`);
                },
                error: () => $('#local-forecast').html('<p class="text-red-500">無法載入預報</p>')
            });
        }

        function fetchTodayTempRange() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    forecastData = data.weatherForecast;
                    renderForecastChart();
                    populateForecastModal();
                }
            });
        }

        function fetchWarnings() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warningInfo&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#warnings-data').empty();
                    const details = data.details || [];
                    if (details.length === 0) {
                        $('#warnings-data').html('<p class="text-gray-600">目前無天氣警告</p>');
                        return;
                    }
                    details.forEach((w) => {
                        const code = w.subtype || w.warningStatementCode;
                        const iconSrc = iconMap[code];
                        if (!iconSrc) return;
                        const name = subtypeMap[code] || code;
                        const time = new Date(w.updateTime).toLocaleString('zh-HK', { hour12: false });
                        const content = w.contents?.join('\n') || "無詳細內容";
                        const $img = $(`
                            <img src="${iconSrc}" alt="${name}" title="${name}" class="w-12 h-12 cursor-pointer rounded-md shadow-md hover:scale-110 transition-transform"
                                data-name="${name}"
                                data-time="${time}"
                                data-content="${content}"
                            />
                        `);
                        $img.on('click', function () {
                            $('#warning-title').text($(this).data('name'));
                            $('#warning-update-time').text('更新時間: ' + $(this).data('time'));
                            $('#warning-content').text($(this).data('content'));
                            $('#warning-modal').removeClass('hidden');
                        });
                        $('#warnings-data').append($img);
                    });
                },
                error: () => $('#warnings-data').html('<p class="text-red-500">無法載入天氣警告</p>')
            });
        }

        function fetchSpecialWeatherTips() {
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=swt&lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    const swt = data.swt || [];
                    if (swt.length === 0) {
                        $('#special-weather-marquee').addClass('hidden');
                        return;
                    }
                    let modalContentHtml = '';
                    swt.forEach((tip, index) => {
                        const desc = tip.desc;
                        const updateTime = new Date(tip.updateTime).toLocaleString('zh-HK', { hour12: false });
                        modalContentHtml += `<span class="text-sm text-gray-600">${updateTime}</span><br><span class="text-base text-gray-700">${desc}</span>`;
                        if (index < swt.length - 1) {
                            modalContentHtml += '<br>';
                        }
                    });
                    $('#special-weather-content').html(modalContentHtml);
                    $('#special-weather-title').text('特別天氣提示');
                    $('#special-weather-modal').removeClass('hidden');
                    let marqueeContentHtml = '';
                    swt.forEach((tip) => {
                        const desc = tip.desc;
                        const updateTime = new Date(tip.updateTime).toLocaleString('zh-HK', { hour12: false });
                        marqueeContentHtml += `<marquee class="text-base text-gray-700 py-1" direction="left" scrollamount="4">${updateTime} - ${desc}</marquee>`;
                    });
                    $('#marquee-content').html(marqueeContentHtml);
                    $('#special-weather-marquee').removeClass('hidden');
                },
                error: () => {
                    console.log('無法載入特別天氣提示');
                    $('#special-weather-marquee').addClass('hidden');
                }
            });
        }

        function renderForecastChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const dates = forecastData.map(f => f.forecastDate);
            const maxTemps = forecastData.map(f => f.forecastMaxtemp.value);
            const minTemps = forecastData.map(f => f.forecastMintemp.value);
            if (window.tempChartInstance) window.tempChartInstance.destroy();
            window.tempChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '最高溫度 (°C)',
                            data: maxTemps,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: '最低溫度 (°C)',
                            data: minTemps,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false, title: { display: true, text: '溫度 (°C)' } },
                        x: { title: { display: true, text: '日期' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#4B5563' } }
                    }
                }
            });
        }

        function populateForecastModal() {
            $('#forecast-data').empty();
            forecastData.forEach(f => {
                const html = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2">${f.forecastDate} (${f.week})</h3>
                        <p>最高氣溫: ${f.forecastMaxtemp.value}°C</p>
                        <p>最低氣溫: ${f.forecastMintemp.value}°C</p>
                        <p>預報: ${f.forecastWeather}</p>
                    </div>
                `;
                $('#forecast-data').append(html);
            });
        }

        function fetchRainfallData() {
            const map = L.map('map').setView([22.3193, 114.1694], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            const stationCoordinates = {
                '上水': [22.505, 114.127],
                '大埔墟': [22.444, 114.171],
                '濕地公園': [22.467, 114.004],
                '屯門': [22.391, 113.975],
                '沙田': [22.402, 114.184],
                '香港國際機場': [22.315, 113.936],
                '昂坪': [22.263, 113.913],
                '坪洲': [22.265, 114.038],
                '長洲': [22.208, 114.029],
                '橫瀾島': [22.186, 114.301],
                '赤柱': [22.218, 114.210],
                '黃竹坑': [22.247, 114.171],
                '跑馬地': [22.268, 114.185],
                '山頂': [22.265, 114.146],
                '筲箕灣': [22.279, 114.228],
                '清水灣': [22.285, 114.294],
                '將軍澳': [22.317, 114.258],
                '觀塘': [22.312, 114.223],
                '尖沙咀': [22.302, 114.174],
                '新蒲崗': [22.336, 114.195],
                '深水埗': [22.333, 114.149],
                '西貢': [22.382, 114.272],
                '滘西洲': [22.371, 114.363],
                '荃灣': [22.372, 114.138]
            };
            const allowedStations = Object.keys(stationCoordinates);
            $.ajax({
                url: 'https://data.weather.gov.hk/weatherAPI/opendata/hourlyRainfall.php?lang=tc',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    data.hourlyRainfall.forEach(station => {
                        let stationName = station.automaticWeatherStation;
                        if (stationName === '香港天文台') {
                            stationName = '尖沙咀';
                        }
                        if (allowedStations.includes(stationName)) {
                            const coords = stationCoordinates[stationName];
                            if (coords) {
                                const rainfall = station.value === 'M' ? 'M' : station.value;
                                const rainfallValue = station.value === 'M' ? 0 : parseFloat(station.value);
                                const popupContent = `<b>${stationName}</b><br>雨量: ${station.value === 'M' ? '維護中/不可用' : `${station.value} mm`}`;
                                let markerClass = 'rainfall-marker-zero';
                                if (station.value === 'M' || rainfallValue === 0) {
                                    markerClass = 'rainfall-marker-zero';
                                } else if (rainfallValue >= 60) {
                                    markerClass = 'rainfall-marker-extreme';
                                } else if (rainfallValue >= 40) {
                                    markerClass = 'rainfall-marker-high';
                                } else if (rainfallValue >= 20) {
                                    markerClass = 'rainfall-marker-medium';
                                } else if (rainfallValue > 0) {
                                    markerClass = 'rainfall-marker-low';
                                }
                                const customIcon = L.divIcon({
                                    className: `rainfall-marker ${markerClass}`,
                                    html: rainfall,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                });
                                L.marker(coords, { icon: customIcon })
                                    .addTo(map)
                                    .bindPopup(popupContent);
                            }
                        }
                    });
                    if (data.hourlyRainfall.length === 0) {
                        alert('暫無數據');
                    }
                },
                error: () => {
                    alert('錯誤：無法載入數據');
                    console.error('無法載入雨量數據');
                }
            });
        }

        $('#tempChart').on('click', () => {
            $('#forecast-modal').removeClass('hidden');
        });

        $('#close-warning-modal').on('click', () => {
            $('#warning-modal').addClass('hidden');
        });

        $('#close-special-weather-modal').on('click', () => {
            $('#special-weather-modal').addClass('hidden');
        });

        $('#close-modal').on('click', () => {
            $('#forecast-modal').addClass('hidden');
        });

        function getRainfallMapUrl(offsetHours = 0) {
            const now = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
            const date = new Date(now);
            if (offsetHours !== 0) {
                date.setHours(date.getHours() - offsetHours);
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = "00";
            const formattedDateTime = `${year}${month}${day}${hours}${minutes}`;
            return `https://www.hko.gov.hk/wxinfo/rainfall/cokrig_barnes/rfmap${formattedDateTime}c.png`;
        }

        function updateRainfallMap(attemptPreviousHour = false) {
            const rainfallMap = $('#rainfall-map');
            const url = getRainfallMapUrl(attemptPreviousHour ? 1 : 0);
            rainfallMap.attr('src', url);
            rainfallMap.off('error').on('error', function () {
                if (!attemptPreviousHour) {
                    updateRainfallMap(true);
                } else {
                    rainfallMap.attr('src', '');
                    rainfallMap.after('<p class="text-red-500 text-center">無法載入雨量圖</p>');
                }
            });
            rainfallMap.siblings('.text-red-500').remove();
        }

        $(document).ready(() => {
            fetchCurrentWeather();
            fetchLocalForecast();
            fetchTodayTempRange();
            fetchWarnings();
            fetchSpecialWeatherTips();
            updateRainfallMap();
            fetchRainfallData();
        });
    </script>
</body>

</html>